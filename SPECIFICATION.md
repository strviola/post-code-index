# 技術資料

## キャッシュファイル

当プログラムでは以下の2種類のキャッシュファイルを使用します。

- post_code.rb (郵便番号インデックス)
- n_gram_dictionary_#{n}.rb (N-gram インデックス)

これらはディレクトリ lib/cache 以下に保存されます。

### 郵便番号インデックス

内容は定数 `POST_CODE_DICTIONARY` が定義された `module` となっています。これは Ruby スクリプトとして読み込むことができ、以下の通り郵便番号とレコードを対応付けています。 (可読性のため一部空白・改行・コメントを追加しています)

```post_code.rb
module PostCode
  POST_CODE_DICTIONARY = {
    "0600000" => [
      ["01101", "060  ", "0600000", "ホッカイドウ", "サッポロシチュウオウク", "イカニケイサイガナイバアイ",
      "北海道", "札幌市中央区", "以下に掲載がない場合", "0", "0", "0", "0", "0", "0"]
    ],
    "0640941" => [
      ["01101", "064  ", "0640941", "ホッカイドウ", "サッポロシチュウオウク", "アサヒガオカ",
      "北海道", "札幌市中央区", "旭ケ丘", "0", "0", "1", "0", "0", "0"]
    ],
    "0600041" => [
      ["01101", "060  ", "0600041", "ホッカイドウ", "サッポロシチュウオウク", "オオドオリヒガシ",
      "北海道", "札幌市中央区", "大通東", "0", "0", "1", "0", "0", "0"]
    ],
    # 中略
  }
end
```

なお、1つの郵便番号に対してレコードは複数存在する場合があるため、郵便番号に対応する値はレコードの配列となっています。

### N-gram インデックス

内容は定数 `N_GRAM_DICTIONARY` が定義された `module` となっています。以下に 2-gram インデックスデータの例を示します。

```n_gram_dictionary_2.rb
module NGramDictionary2
  N_GRAM_DICTIONARY = {
    "北海" => ["0600000", "0640941", "0600041", "0600042", "0640820",], # 途中省略
    "海道" => ["0600000", "0640941", "0600041", "0600042", "0640820",], # 途中省略
    # 中略
  }
end
```

## 検索方式

1. post_code.rb が存在しない場合、以下の処理を行う。存在する場合は次に進む。
  - [郵便番号CSVデータ](http://www.post.japanpost.jp/zipcode/dl/kogaki/zip/ken_all.zip) をダウンロード
  - Zip ファイルを展開
  - 文字コードが Shift-JIS なので UTF-8 に変換し KEN_ALL_UTF.csv として lib/cache に
  - KEN_ALL_UTF.csv を読み取り、郵便番号インデックスに変換して post_code.rb として保存
1. 実行引数から keyword, n を読み取る。
1. n_gram_dictionary_#{n}.rb が存在しない場合、以下の処理を行う。存在する場合は次に進む。
  - KEN_ALL_UTF.csv を読み取り、 N-gram インデックスに変換して n_gram_dictionary_#{n}.rb として保存
1. keyword を n 文字ずつに分割する。
1. `N_GRAM_DICTIONARY` から郵便番号の一覧を取得する。
1. `POST_CODE_DICTIONARY` から郵便番号に対応するレコードを取得し、結果を表示する。
  - データが分割されている場合は結合して表示される。
